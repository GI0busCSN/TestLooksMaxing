import{v,i as B,a4 as P,a5 as R,A as V}from"./index-D4Sq2tbE.js";function i(e){return new Promise((r,t)=>{e.oncomplete=e.onsuccess=()=>r(e.result),e.onabort=e.onerror=()=>t(e.error)})}function j(e,r){let t;const a=()=>{if(t)return t;const o=indexedDB.open(e);return o.onupgradeneeded=()=>o.result.createObjectStore(r),t=i(o),t.then(u=>{u.onclose=()=>t=void 0},()=>{}),t};return(o,u)=>a().then(s=>u(s.transaction(r,o).objectStore(r)))}let w;function l(){return w||(w=j("keyval-store","keyval")),w}function x(e,r=l()){return r("readonly",t=>i(t.get(e)))}function z(e,r,t=l()){return t("readwrite",a=>(a.put(r,e),i(a.transaction)))}function F(e,r,t=l()){return t("readwrite",a=>new Promise((o,u)=>{a.get(e).onsuccess=function(){try{a.put(r(this.result),e),o(i(a.transaction))}catch(s){u(s)}}}))}function G(e,r=l()){return r("readwrite",t=>(t.delete(e),i(t.transaction)))}function W(e,r,t={}){const{flush:a="pre",deep:o=!0,shallow:u=!1,onError:s=n=>{console.error(n)},writeDefaults:y=!0,serializer:f={read:n=>n,write:n=>n}}=t,p=v(!1),c=(u?v:B)(r),d=P(r);async function m(){try{const n=await x(e);n===void 0?d!=null&&y&&await z(e,f.write(d)):c.value=f.read(n)}catch(n){s(n)}p.value=!0}m();async function h(){try{if(c.value==null)await G(e);else{const n=V(c.value),S=f.write(n);await F(e,()=>S)}}catch(n){s(n)}}const{pause:b,resume:g}=R(c,()=>h(),{flush:a,deep:o});async function D(n){b(),c.value=n,await h(),g()}return{set:D,isFinished:p,data:c}}export{W as u};
